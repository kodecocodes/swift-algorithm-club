# Boyer-Moore å­—ç¬¦ä¸²æœç´¢

ç›®æ ‡ï¼šä¸å¯¼å…¥ `Foundation` æˆ–è€…ä½¿ç”¨ `NSString` çš„ `rangeOfString()`æ–¹æ³•çš„æƒ…å†µä¸‹ç”¨çº¯ Swift å†™ä¸€ä¸ªå­—ç¬¦ä¸²æœç´¢ç®—æ³•ã€‚

æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬æƒ³è¦å®ç°ä¸€ä¸ª `String` çš„ `indexOf(pattern: String)` æ‰©å±•ï¼Œè¿”å›ç¬¬ä¸€ä¸ªå‡ºç°çš„æœç´¢è¯çš„ `String.Index`ï¼Œå¦‚æœåœ¨å­—ç¬¦ä¸²é‡Œæ²¡æœ‰æ‰¾åˆ°çš„è¯å°±è¿”å› `nil`ã€‚

ä¾‹å¦‚:

```swift
// Input:
let s = "Hello, World"
s.indexOf(pattern: "World")

// Output:
<String.Index?> 7

// Input:
let animals = "ğŸ¶ğŸ”ğŸ·ğŸ®ğŸ±"
animals.indexOf(pattern: "ğŸ®")

// Output:
<String.Index?> 6
```

> **æ³¨æ„ï¼š** ç‰›çš„ç´¢å¼•æ˜¯ 6ï¼Œè€Œä¸æ˜¯çœ‹åˆ°çš„ 3ï¼Œå› ä¸º emoji ä½¿ç”¨äº†æ›´å¤šçš„å­˜å‚¨ç©ºé—´ã€‚`String.Index` çš„å®é™…å€¼å¹¶ä¸æ˜¯å¾ˆé‡è¦ï¼Œé‡ç‚¹æ˜¯è¦æŒ‡å‘å­—ç¬¦ä¸²ä¸­æ­£ç¡®çš„å­—ç¬¦ã€‚

[æš´åŠ›æ–¹å¼](../Brute-Force%20String%20Search/README-CN.markdown) èƒ½å¤Ÿå¾ˆå¥½çš„å·¥ä½œï¼Œä½†æ˜¯ä¸å¤Ÿæœ‰æ•ˆï¼Œå°¤å…¶æ˜¯æœ‰ä¸€å¤§æ®µæ–‡æœ¬çš„æ—¶å€™ã€‚å°±åƒä¸Šé¢çœ‹åˆ°çš„ï¼Œæˆ‘ä»¬ä¸éœ€è¦æŸ¥æ‰¾æºå­—ç¬¦ä¸²ä¸­çš„ _æ¯ä¸ª_ å­—ç¬¦â€”â€”å¯ä»¥è·³è¿‡å¤šä¸ªå­—ç¬¦ã€‚

è·³è¿‡å¤´éƒ¨ç®—æ³•å«åš [Boyer-Moore](https://en.wikipedia.org/wiki/Boyerâ€“Moore_string_search_algorithm) ï¼Œè¿™ä¸ªç®—æ³•å·²ç»å­˜åœ¨æœ‰å¾ˆé•¿ä¸€æ®µæ—¶é—´ã€‚å®ƒè¢«è®¤ä¸ºæ˜¯æ‰€æœ‰å­—ç¬¦ä¸²æœç´¢ç®—æ³•çš„æ ‡æ†ã€‚

ä¸‹é¢æ˜¯ Swift ä¸­çš„å®ç°ï¼š

```swift
extension String {
    func index(of pattern: String) -> Index? {
        // å…ˆç¼“å­˜éœ€è¦æœç´¢çš„å­—ç¬¦ä¸²çš„é•¿åº¦
        // å› ä¸ºåœ¨åé¢æˆ‘ä»¬ä¼šç»å¸¸ç”¨åˆ°å®ƒï¼Œæ¯æ¬¡éƒ½è®¡ç®—çš„è¯å°±ä¸å¤ªåˆ’ç®—äº†ã€‚
        let patternLength = pattern.characters.count
        guard patternLength > 0, patternLength <= characters.count else { return nil )
      
        // åšä¸€ä¸ªä½ç§»è¡¨ã€‚è¿™ä¸ªè¡¨ç”¨æ¥åœ¨å½“æ‰¾åˆ°äº†ä¸€ä¸ªåŒ¹é…çš„å­—ç¬¦ä¸²çš„æ—¶å€™å‘Šè¯‰æˆ‘ä»¬è¦ä½ç§»å¤šè¿œ
        var skipTable = [Character: Int]()
        for (i, c) in pattern.characters.enumerated() {
            skipTable[c] = patternLength - i - 1
        }

        // æŒ‡å‘æœç´¢è¯é‡Œçš„æœ€åä¸€ä¸ªå­—ç¬¦
        let p = pattern.index(before: pattern.endIndex)
        let lastChar = pattern[p]

      
        // ä»å³åˆ°å·¦å¼€å§‹æ‰«æï¼Œæ‰€ä»¥å…ˆè·³è¿‡æœç´¢è¯çš„é•¿åº¦ã€‚ï¼ˆå‡ 1 æ˜¯å› ä¸º startIndex å·²ç»æŒ‡å‘äº†æºå­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼‰
        var i = index(startIndex, offsetBy: patternLength - 1)
        
        // è¿™æ˜¯ä¸€ä¸ªè¾…åŠ©æ–¹æ³•ï¼Œç”¨æ¥ä»ä¸¤ä¸ªå­—ç¬¦ä¸²çš„åé¢å¾€å‰æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªä¸åŒ¹é…çš„å­—ç¬¦ï¼Œæˆ–è€…æ˜¯ç›´åˆ°æœç´¢è¯çš„å¼€å§‹
        func backwards() -> Index? {
            var q = p
            var j = i
            while q > pattern.startIndex {
                j = index(before: j)
                q = index(before: q)
                if self[j] != pattern[q] { return nil }
            }
            return j
        }

        // ä¸»å¾ªç¯ã€‚ä¸€ç›´æ‰¾ï¼ŒçŸ¥é“å­—ç¬¦ä¸²çš„ç»“å°¾
        while i < endIndex {
            let c = self[i]

            // å½“å‰å­—ç¬¦æ˜¯å¦ä¸æœç´¢è¯é‡Œçš„æœ€åä¸€ä¸ªå­—ç¬¦åŒ¹é…
            if c == lastChar {

                // æ‰¾åˆ°äº†ä¸€ä¸ªåŒ¹é…ã€‚ç»§ç»­å¾€ååš brute-force æœç´¢
                if let k = backwards() { return k }

                // å¦‚æœæ²¡æœ‰åŒ¹é…çš„ï¼Œæˆ‘ä»¬åªè¦å®‰å…¨çš„å¾€å‰ç§»åŠ¨ä¸€ä¸ªå­—ç¬¦
                i = index(after: i)
            } else {
                // å­—ç¬¦ä¸åŒ¹é…ï¼Œæ‰€ä»¥è¦è·³è¿‡ã€‚è¦è·³è¿‡çš„æ•°é‡æ˜¯ç”±ä½ç§»è¡¨å†³å®šçš„ã€‚
                // å¦‚æœå­—ç¬¦ä¸²æ²¡æœ‰åœ¨æœç´¢è¯ä¸­å‡ºç°ï¼Œæˆ‘ä»¬å¯ä»¥è·³è¿‡æ•´ä¸ªæœç´¢è¯çš„é•¿åº¦
                // ç„¶è€Œï¼Œå¦‚æœå­—ç¬¦åœ¨æœç´¢è¯ä¸­å‡ºç°äº†ï¼Œå‰é¢å¯èƒ½æœ‰ä¸€ä¸ªåŒ¹é…ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ä½ç§»å¤ªå¤š
                i = index(i, offsetBy: skipTable[c] ?? patternLength, limitedBy: endIndex) ?? endIndex
            }
        }
        return nil
    }
}
```

ç®—æ³•æ˜¯åƒä¸‹é¢è¿™æ ·å·¥ä½œçš„ã€‚å°†æºå­—ç¬¦ä¸²å’Œéœ€è¦æœç´¢çš„å­—ç¬¦ä¸²å¯¹é½ï¼Œç„¶åçœ‹çœ‹å“ªä¸ªå­—ç¬¦ä¸è¦åŒ¹é…çš„å­—ç¬¦ä¸²çš„ _æœ€å_ ä¸€ä¸ªå­—ç¬¦åŒ¹é…ï¼š

```
source string:  Hello, World
search pattern: World
                    ^
```

æœ‰ä¸‰ä¸­å¯èƒ½ï¼š

1. ä¸¤ä¸ªå­—ç¬¦ç›¸ç­‰ï¼Œæ‰¾åˆ°äº†ä¸€ä¸ªå¯èƒ½çš„åŒ¹é…ã€‚

2. å­—ç¬¦ä¸ç›¸ç­‰ï¼Œä½†æ˜¯å­—ç¬¦åœ¨æœç´¢è¯ä¸­å‡ºç°è¿‡ã€‚

3. å­—ç¬¦æ ¹æœ¬æ²¡æœ‰åœ¨æœç´¢è¯ä¸­å‡ºç°ã€‚

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå­—ç¬¦ `o` å’Œ `d` ä¸åŒ¹é…ï¼Œä½†æ˜¯ `o` å‡ºç°åœ¨äº†æœç´¢è¯ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è·³è¿‡ä¸€äº›ä½ç½®ï¼š

```
source string:  Hello, World
search pattern:    World
                       ^
```

ç°åœ¨ä¸¤ä¸ª `o` å­—ç¬¦å·²ç»å¯¹é½äº†ã€‚ç°åœ¨æˆ‘ä»¬å°†æœç´¢è¯ä¸­çš„æœ€åä¸€ä¸ªå­—ç¬¦ `d` å’Œ `W` åšå¯¹æ¯”ã€‚ä»–ä»¬æ˜¯ä¸ç›¸ç­‰çš„ï¼Œä½†æ˜¯ `W` å‡ºç°åœ¨äº†æœç´¢è¯ä¸­ã€‚æ‰€ä»¥å†ç§»åŠ¨å‡ ä¸ªä½ç½®ä»¥ä½¿ `W` å¯¹é½ï¼š

```
source string:  Hello, World
search pattern:        World
                           ^
```

ç°åœ¨è¿™ä¸¤ä¸ªå­—ç¬¦æ˜¯ç›¸ç­‰çš„ï¼Œç„¶åå°±æœ‰äº†ä¸€ä¸ªå¯èƒ½çš„åŒ¹é…ã€‚ä¸ºäº†éªŒè¯è¿™ä¸ªåŒ¹é…ï¼Œå†åšä¸€æ¬¡ brute-force æœç´¢ï¼Œä¸æ˜¯æ˜¯å¾€åçš„ï¼Œä»æœç´¢è¯çš„æœ€ååˆ°å¼€å§‹ï¼Œç„¶åå…¨éƒ¨æ‰¾åˆ°äº†ã€‚

ä»»ä½•æ—¶å€™ä½ç§»çš„æ•°é‡æ˜¯ç”± â€œä½ç§»è¡¨â€ å†³å®šçš„ï¼Œå®ƒæ˜¯ä¸€ä¸ªå­—å…¸ï¼Œé‡Œé¢åŒ…å«äº†æœç´¢æ–¹å¼ä¸­çš„æ¯ä¸ªå­—ç¬¦ä»¥åŠä»–ä»¬å¯¹åº”çš„çš„ä½ç§»ä¸ªæ•°ã€‚ä½ç§»è¡¨çœ‹èµ·æ¥å°±æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š

```
W: 4
o: 3
r: 2
l: 1
d: 0
```

å­—ç¬¦è¶Šé è¿‘æœç´¢è¯çš„å°¾éƒ¨ï¼Œè¦ä½ç§»çš„æ•°é‡å°±è¶Šå°‘ã€‚å¦‚æœå­—ç¬¦åœ¨æœç´¢è¯ä¸­å‡ºç°äº†å¤šæ¬¡ï¼Œæœ€é è¿‘æœç´¢è¯å°¾éƒ¨çš„å­—ç¬¦å†³å®šç€è¦ç§»åŠ¨çš„æ•°é‡ã€‚

> **æ³¨æ„ï¼š** å¦‚æœæœç´¢è¯æ˜¯ç”±å¾ˆå°‘çš„å­—ç¬¦ä¸²ç»„æˆï¼Œåšä¸€æ¬¡ brute-force æœç´¢æ˜¯å¾ˆå¿«çš„ã€‚åœ¨å¯¹çŸ­æœç´¢è¯å»ºç«‹ä½ç§»è¡¨å’Œåš  brute-force æœç´¢çš„æ—¶å€™ä¼šæœ‰ä¸€ä¸ªå–èˆã€‚

å‚è€ƒ: ä¸Šé¢çš„ä»£ç æ˜¯åŸºäºDr Dobb's æ‚å¿—ä¸Šçš„è¿™ç¯‡æ–‡ç«  [Costas Menico æ›´å¿«çš„å­—ç¬¦ä¸²æœç´¢](http://www.drdobbs.com/database/faster-string-searches/184408171) , ä¸ƒæœˆ 1989 -- æ˜¯çš„, 1989ï¼æœ‰æ—¶å€™ä¿ç•™è¿™äº›å¤è€çš„æ‚å¿—æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚
å‚è€ƒ: [ç®—æ³•çš„è¯¦ç»†åˆ†æ](http://www.inf.fh-flensburg.de/lang/algorithmen/pattern/bmen.htm)

## Boyer-Moore-Horspool algorithm

ä¸Šé¢ç®—æ³•çš„ä¸€ä¸ªå˜ç§æ˜¯ [Boyer-Moore-Horspool ç®—æ³•](https://en.wikipedia.org/wiki/Boyer%E2%80%93Moore%E2%80%93Horspool_algorithm)ã€‚

è·Ÿä¸€èˆ¬çš„ Boyer-Moore ç®—æ³•ç›¸åŒçš„æ˜¯ï¼Œå®ƒä½¿ç”¨ `ä½ç§»è¡¨` æ¥è·³è¿‡ä¸€äº›å­—ç¬¦ã€‚ä¸åŒçš„åœ°æ–¹åœ¨äºæ€ä¹ˆæ£€æŸ¥éƒ¨åˆ†åŒ¹é…ã€‚åœ¨ä¸Šé¢çš„ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœæ‰¾åˆ°äº†ä¸€ä¸ªéƒ¨åˆ†åŒ¹é…ä½†ä¸æ˜¯å®Œå…¨åŒ¹é…ï¼Œæˆ‘ä»¬åªè·³è¿‡ä¸€ä¸ªå­—ç¬¦ã€‚åœ¨è¿™ä¸ªæ›´èªæ˜çš„ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬ä¸€æ ·ä½¿ç”¨ä½ç§»è¡¨æ¥å¤„ç†ä¸Šé¢çš„æƒ…å†µã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ª  Boyer-Moore-Horspool ç®—æ³•çš„å®ç°ï¼š

```swift
extension String {
    func index(of pattern: String) -> Index? {
        // å…ˆç¼“å­˜éœ€è¦æœç´¢çš„å­—ç¬¦ä¸²çš„é•¿åº¦
        // å› ä¸ºåœ¨åé¢æˆ‘ä»¬ä¼šç»å¸¸ç”¨åˆ°å®ƒï¼Œæ¯æ¬¡éƒ½è®¡ç®—çš„è¯å°±ä¸å¤ªåˆ’ç®—äº†ã€‚
        let patternLength = pattern.characters.count
        guard patternLength > 0, patternLength <= characters.count else { return nil }

        // ç®€å†ä½ç§»è¡¨ã€‚è¿™ä¸ªè¡¨å†³å®šåœ¨æ‰¾åˆ°åŒ¹é…å­—ç¬¦ä¹‹åéœ€è¦ä½ç§»çš„æ•°é‡
        var skipTable = [Character: Int]()
        for (i, c) in pattern.characters.enumerated() {
            skipTable[c] = patternLength - i - 1
        }

        // æŒ‡å‘æœç´¢è¯çš„æœ€åä¸€ä¸ªå­—ç¬¦
        let p = pattern.index(before: pattern.endIndex)
        let lastChar = pattern[p]

        // ä»å³åˆ°å·¦æ‰«ææœç´¢è¯ï¼Œæ‰€ä»¥å…ˆè·³è¿‡æœç´¢è¯çš„é•¿åº¦ã€‚ï¼ˆå‡ 1 æ˜¯å› ä¸º startIndex å·²ç»æŒ‡å‘äº†æºå­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼‰
        var i = index(startIndex, offsetBy: patternLength - 1)

        // è¿™æ˜¯ä¸€ä¸ªè¾…åŠ©æ–¹æ³•ï¼Œä»åå¾€å‰æœç´¢ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œç›´åˆ°æˆ‘ä»¬æ‰¾ä¸€ä¸ªä¸åŒ¹é…çš„å­—ç¬¦ï¼Œæˆ–è€…æ˜¯åˆ°äº†æœç´¢è¯çš„å¼€å§‹ã€‚
        func backwards() -> Index? {
            var q = p
            var j = i
            while q > pattern.startIndex {
                j = index(before: j)
                q = index(before: q)
                if self[j] != pattern[q] { return nil }
            }
            return j
        }

        // ä¸»å¾ªç¯ï¼Œç›´åˆ°æºå­—ç¬¦ä¸²çš„ç»“å°¾
        while i < endIndex {
            let c = self[i]

            // å½“å‰å­—ç¬¦ä¸²æ˜¯å¦ä¸æœç´¢è¯çš„æœ€åä¸€ä¸ªå­—ç¬¦åŒ¹é…
                if c == lastChar {

                // æœ‰ä¸€ä¸ªåŒ¹é…ï¼Œä»åé¢å¼€å§‹åš brute-force æœç´¢
                if let k = backwards() { return k }

                // ç¡®ä¿æœ€å°‘è¦è·³è¿‡ä¸€ä¸ªå­—ç¬¦ï¼ˆå› ä¸ºä½ç§»è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå­—ç¬¦çš„ä½ç§»æ˜¯ `skipTable[lastChar] = 0` ï¼‰
                let jumpOffset = max(skipTable[c] ?? patternLength, 1)
                i = index(i, offsetBy: jumpOffset, limitedBy: endIndex) ?? endIndex
            } else {
                // å­—ç¬¦ä¸åŒ¹é…ï¼Œæ‰€ä»¥è¦è·³è¿‡ã€‚è¦è·³è¿‡çš„æ•°é‡æ˜¯ç”±ä½ç§»è¡¨å†³å®šçš„ã€‚
                // å¦‚æœå­—ç¬¦ä¸²æ²¡æœ‰åœ¨æœç´¢è¯ä¸­å‡ºç°ï¼Œæˆ‘ä»¬å¯ä»¥è·³è¿‡æ•´ä¸ªæœç´¢è¯çš„é•¿åº¦
                // ç„¶è€Œï¼Œå¦‚æœå­—ç¬¦åœ¨æœç´¢è¯ä¸­å‡ºç°äº†ï¼Œå‰é¢å¯èƒ½æœ‰ä¸€ä¸ªåŒ¹é…ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ä½ç§»å¤ªå¤š
                i = index(i, offsetBy: skipTable[c] ?? patternLength, limitedBy: endIndex) ?? endIndex
            }
        }
        return nil
    }
}
```

åœ¨å®é™…ä¸­ï¼ŒHorspool çœ‹èµ·æ¥è¡¨ç°è¦æ¯”åŸæ¥çš„ç‰ˆæœ¬æ›´å¥½ä¸€äº›ã€‚ç„¶è€Œï¼Œè¿™æ˜¯ç”±ä½ æƒ³è¦åšçš„å–èˆå†³å®šçš„ã€‚

å‚è€ƒ: ä»£ç æ˜¯åŸºäºè¿™ç¯‡è®ºæ–‡: [R. N. Horspool (1980). "Practical fast searching in strings". Software - Practice & Experience 10 (6): 501â€“506.](http://www.cin.br/~paguso/courses/if767/bib/Horspool_1980.pdf)

_ä½œè€…ï¼šMatthijs Hollemans, Andreas NeusÃ¼ÃŸï¼Œ [MatÃ­as Mazzei](https://github.com/mmazzei) æ›´æ–°ï¼Œç¿»è¯‘ï¼šDaisy_.


